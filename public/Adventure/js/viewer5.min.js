function validate(e,t){var i={form:{},error:!1,errorMsg:"",errorFields:[]};for(var n in t){switch(t[n].type=t[n].type||"uint",t[n].required=t[n].required||!1,t[n].maxLength=t[n].maxLength||0,null==e.selector?(t[n].value=e[t[n].name],"bit"==t[n].type&&1!=t[n].value&&(t[n].value=0)):(t[n].value=e.find(" [name='"+t[n].name+"']").val(),"checkbox"==e.find("[name='"+t[n].name+"']").attr("type")&&""==t[n].value&&(t[n].value=0)),t[n].required&&""==t[n].value&&(i.errorMsg+="<li>"+t[n].name+" is required.</li>",i.errorFields.push(t[n].name)),t[n].type){case"uint":$.isNumeric(t[n].value)||""==t[n].value?$.isNumeric(t[n].value)&&(t[n].value>4294967295?(i.errorMsg+="<li>"+t[n].name+" is too large.</li>",i.errorFields.push(t[n].name)):t[n].value<0&&(i.errorMsg+="<li>"+t[n].name+" is too low.</li>",i.errorFields.push(t[n].name))):(i.errorMsg+="<li>"+t[n].name+" is invalid.</li>",i.errorFields.push(t[n].name));break;case"int":$.isNumeric(t[n].value)||""==t[n].value?$.isNumeric(t[n].value)&&(t[n].value>2147483647?(i.errorMsg+="<li>"+t[n].name+" is too large.</li>",i.errorFields.push(t[n].name)):t[n].value<-2147483648&&(i.errorMsg+="<li>"+t[n].name+" is too low.</li>",i.errorFields.push(t[n].name))):(i.errorMsg+="<li>"+t[n].name+" is invalid.</li>",i.errorFields.push(t[n].name));break;case"tinyint":$.isNumeric(t[n].value)||""==t[n].value?$.isNumeric(t[n].value)&&(t[n].value>255?(i.errorMsg+="<li>"+t[n].name+" is too large.</li>",i.errorFields.push(t[n].name)):t[n].value<0&&(i.errorMsg+="<li>"+t[n].name+" is too low.</li>",i.errorFields.push(t[n].name))):(i.errorMsg+="<li>"+t[n].name+" is invalid.</li>",i.errorFields.push(t[n].name));break;case"bit":0!=t[n].value&&1!=t[n].value&&(i.errorMsg+="<li>"+t[n].name+" is invalid.</li>",i.errorFields.push(t[n].name));break;case"string":t[n].value.length>=t[n].maxLength&&(i.errorMsg+="<li>"+t[n].name+" must be "+t[n].maxLength+" characters or less. It is currently "+t[n].value.length+" characters long.</li>",i.errorFields.push(t[n].name));break;case"percent":t[n].value.length>=t[n].maxLength?(i.errorMsg+="<li>"+t[n].name+" must be "+t[n].maxLength+" characters or less. It is currently "+t[n].value.length+" characters long.</li>",i.errorFields.push(t[n].name)):-1==t[n].value.search(/^[0-9]+(\.[0-9]+)?%$/)&&(i.errorMsg+="<li>"+t[n].name+" is an invalid percentage.</li>",i.errorFields.push(t[n].name));break;case"decimal":t[n].value.length>=t[n].maxLength?(i.errorMsg+="<li>"+t[n].name+" must be "+t[n].maxLength+" characters or less. It is currently "+t[n].value.length+" characters long.</li>",i.errorFields.push(t[n].name)):-1==t[n].value.search(/^[0-9]+(\.[0-9]+)?$/)&&(i.errorMsg+="<li>"+t[n].name+" is an invalid decimal.</li>",i.errorFields.push(t[n].name))}i.form[t[n].name]=t[n].value}return i.error=""!=i.errorMsg,i}function int(e){return parseInt(e)||0}var Adventure=new Marionette.Application;Adventure.Templates={},Adventure.assetPath="undefined"!=typeof Adventure.assetPath?Adventure.assetPath:"",Marionette.TemplateCache.prototype.loadTemplate=function(e){return Adventure.Templates[e]},Adventure.addCSSSupport=function(e){return keyframes=e.replace(/transform: ([^;]+);/g,"transform: $1; -webkit-transform: $1; -ms-transform: $1;"),keyframes=keyframes.replace(/filter: ([^;]+);/g,"filter: $1; -webkit-filter: $1; -moz-filter: $1;")},Adventure.AdventureModel=Backbone.Model.extend({defaults:{hashKey:"",title:"",description:"",author:"",imageID:"",imageURL:"",imageX:"50%",imageY:"50%",imageScale:"1",published:0},idAttribute:"ID",initialize:function(){this.set("events",new Adventure.Events),this.set("scenes",new Adventure.Scenes),this.set("images",new Adventure.Images),this.set("effects",new Adventure.Effects),this.set("pages",new Adventure.Pages),this.set("flags",new Adventure.Flags),this.form=this.attributes},urlRoot:"services/adventure.php",parse:function(e){var t=["pages","flags","events","scenes","images","effects"];for(i=0;i<t.length;i++)void 0!=e[t[i]]&&(this.get(t[i]).add(e[t[i]]),delete e[t[i]]);return e},validate:function(){var e=validate(this.form,[{name:"title",required:!0,type:"string",maxLength:100},{name:"description",required:!0,type:"string",maxLength:500}]);return e.error?(Adventure.handleInvalidInput(e),e):void 0}}),Adventure.Adventures=Backbone.Collection.extend({model:Adventure.AdventureModel,url:"services/adventures.php"}),Adventure.AdventureViewingModel=Backbone.Model.extend({defaults:{hashKey:"",title:"",description:"",imageID:0,published:0,events:[],scenes:[],images:[],effects:[],pages:[],flags:[]},idAttribute:"ID",initialize:function(){var e=this;Adventure.activeAdventure=this,this.urlRoot=Adventure.assetPath+this.urlRoot,this.fetch({wait:!0,data:{hashKey:this.get("hashKey")},success:function(){e.set("scenes",new Adventure.Scenes(e.get("scenes"))),e.set("images",new Adventure.Images(e.get("images"))),e.set("effects",new Adventure.Effects(e.get("effects"))),e.set("pages",new Adventure.Pages(e.get("pages"))),e.set("flags",new Adventure.Flags(e.get("flags"))),e.set("events",new Adventure.Events(e.get("events")))},error:function(){alert("An error occurred while loading the adventure.")}})},urlRoot:"services/loadAdventure.php"}),Adventure.PageModel=Backbone.Model.extend({defaults:{name:"",text:"",sceneID:0,pageTypeID:1,imageID:0,effectID:0,actions:[],pageEvents:[]},idAttribute:"ID",initialize:function(){this.initSubItems(),this.form=this.attributes,this.handleBlankName(),this.on("sync",this.handleBlankName),this.set("filteredText",this.get("text").replace(/\r?\n/g,"<br>"))},initSubItems:function(){Array.isArray(this.get("actions"))&&this.set("actions",new Adventure.Actions(this.get("actions"))),Array.isArray(this.get("pageEvents"))&&this.set("pageEvents",new Adventure.PageEvents(this.get("pageEvents")))},handleBlankName:function(){this.get("name")||this.set("name","(New page #"+this.id+")")},urlRoot:"services/page.php",validate:function(){var e=validate(this.form,[{name:"name",required:!0,type:"string",maxLength:50},{name:"text",required:!0,type:"string",maxLength:2e3},{name:"sceneID",required:!0,type:"uint"},{name:"pageTypeID",required:!0,type:"tinyint"},{name:"imageID",required:!1,type:"uint"},{name:"effectID",required:!1,type:"uint"}]);return e.error?(Adventure.handleInvalidInput(e),e):void 0}}),Adventure.Pages=Backbone.Collection.extend({model:Adventure.PageModel}),Adventure.ActionModel=Backbone.Model.extend({defaults:{priority:1,actionTypeID:1,text:"",nextPageID:0,effectID:0,transitionID:1,actionFlagRequirements:[],actionEvents:[]},idAttribute:"ID",initialize:function(){this.initSubItems(),this.form=this.attributes,this.handleBlankName(),this.on("sync",this.handleBlankName)},initSubItems:function(){Array.isArray(this.get("actionFlagRequirements"))&&this.set("actionFlagRequirements",new Adventure.ActionFlagRequirements(this.get("actionFlagRequirements"))),Array.isArray(this.get("actionEvents"))&&this.set("actionEvents",new Adventure.ActionEvents(this.get("actionEvents")))},handleBlankName:function(){this.get("text")||this.set("text","(New action #"+this.id+")")},urlRoot:"services/action.php",validate:function(){var e=validate(this.form,[{name:"priority",required:!0,type:"tinyint"},{name:"actionTypeID",required:!0,type:"tinyint"},{name:"text",required:!0,type:"string",maxLength:500},{name:"nextPageID",required:!0,type:"uint"},{name:"effectID",required:!1,type:"uint"},{name:"transitionID",required:!0,type:"tinyint"}]);return e.error?(Adventure.handleInvalidInput(e),e):void 0}}),Adventure.Actions=Backbone.Collection.extend({model:Adventure.ActionModel}),Adventure.ActionFlagRequirementModel=Backbone.Model.extend({defaults:{name:"",conditionID:1,flagID:0,counterValue:null,counterUpperValue:null,pageID:0,otherFlagID:0},idAttribute:"ID",initialize:function(){this.on("sync",this.updateName),this.form=this.attributes},updateName:function(){var e=int(this.get("flagID"))?Adventure.activeAdventure.get("flags").get(this.get("flagID")).get("name"):"New Requirement",t=int(this.get("otherFlagID"))?Adventure.activeAdventure.get("flags").get(this.get("otherFlagID")).get("name"):"",i=e;switch(int(this.get("conditionID"))){case 1:i="Always Trigger";break;case 2:i=e+" Active";break;case 3:i=e+" Inactive";break;case 4:i=e+" = "+(t?t:this.get("counterValue"));break;case 5:i=e+" != "+(t?t:this.get("counterValue"));break;case 6:i=e+" < "+(t?t:this.get("counterValue"));break;case 7:i=e+" <= "+(t?t:this.get("counterValue"));break;case 8:i=e+" > "+(t?t:this.get("counterValue"));break;case 9:i=e+" >= "+(t?t:this.get("counterValue"));break;case 10:i=e+" between "+this.get("counterValue")+" and "+this.get("counterUpperValue");break;case 11:i=e+" not between "+this.get("counterValue")+" and "+this.get("counterUpperValue");break;case 12:i=this.get("counterValue")+"% chance";break;case 13:i="Page = "+Adventure.activeAdventure.get("pages").get(this.get("pageID")).get("name");break;case 14:i="Page != "+Adventure.activeAdventure.get("pages").get(this.get("pageID")).get("name")}this.set("name",i)},urlRoot:"services/actionFlagRequirement.php",validate:function(){var e=int(this.form.find("[name='conditionID']").val())>1&&int(this.form.find("[name='conditionID']").val())<11,t=int(Adventure.conditions.get(this.form.find("[name='conditionID']").val()).get("involvesCounter")),i=int(Adventure.conditions.get(this.form.find("[name='conditionID']").val()).get("involvesRange")),n=int(Adventure.conditions.get(this.form.find("[name='conditionID']").val()).get("involvesPage")),a=validate(this.form,[{name:"conditionID",required:!0,type:"tinyint"},{name:"flagID",required:e,type:"uint"},{name:"counterValue",required:t,type:"int"},{name:"counterUpperValue",required:i,type:"int"},{name:"pageID",required:n,type:"uint"},{name:"otherFlagID",required:t&&!i,type:"uint"}]);return a.error?(Adventure.handleInvalidInput(a),a):void 0}}),Adventure.ActionFlagRequirements=Backbone.Collection.extend({model:Adventure.ActionFlagRequirementModel}),Adventure.SceneModel=Backbone.Model.extend({defaults:{name:"",actions:[],sceneEvents:[]},idAttribute:"ID",initialize:function(){this.initSubItems(),this.form=this.attributes,this.handleBlankName(),this.on("sync",this.handleBlankName)},initSubItems:function(){Array.isArray(this.get("actions"))&&this.set("actions",new Adventure.Actions(this.get("actions"))),Array.isArray(this.get("sceneEvents"))&&this.set("sceneEvents",new Adventure.SceneEvents(this.get("sceneEvents")))},handleBlankName:function(){this.get("name")||this.set("name","(New scene #"+this.id+")")},urlRoot:"services/scene.php",validate:function(){var e=validate(this.form,[{name:"name",required:!0,type:"string",maxLength:50}]);return e.error?(Adventure.handleInvalidInput(e),e):void 0},setSceneID:function(e){e.set("sceneID",this.ID)}}),Adventure.Scenes=Backbone.Collection.extend({model:Adventure.SceneModel}),Adventure.FlagModel=Backbone.Model.extend({defaults:{name:"",isItem:0,description:"",imageID:null,isCounter:0,counterDefault:null,counterMinimum:null,counterMaximum:null,counterWraps:0},idAttribute:"ID",urlRoot:"services/flag.php",initialize:function(){this.handleBlankName(),this.on("sync",this.handleBlankName)},handleBlankName:function(){this.get("name")||this.set("name","(New flag #"+this.id+")")},validate:function(){var e=validate(this.form,[{name:"name",required:!0,type:"string",maxLength:50},{name:"isItem",required:!0,type:"bit"},{name:"description",required:!1,type:"string",maxLength:200},{name:"imageID",required:!1,type:"uint"},{name:"isCounter",required:!0,type:"bit"},{name:"counterDefault",required:!1,type:"int"},{name:"counterMinimum",required:!1,type:"int"},{name:"counterMaximum",required:!1,type:"int"},{name:"counterWraps",required:!0,type:"bit"}]);return e.error?(Adventure.handleInvalidInput(e),e):void 0}}),Adventure.Flags=Backbone.Collection.extend({model:Adventure.FlagModel}),Adventure.ImageModel=Backbone.Model.extend({defaults:{URL:"",width:0,height:0,centerX:"50%",centerY:"50%",scale:"1"},idAttribute:"ID",urlRoot:"services/image.php",validate:function(){var e=validate(this.form,[{name:"centerX",required:!0,type:"percent",maxLength:10},{name:"centerY",required:!0,type:"percent",maxLength:10},{name:"scale",required:!0,type:"decimal",maxLength:10}]);return e.error?(Adventure.handleInvalidInput(e),e):void 0},applyAdjustment:function(e){e.css("transform","translateX(-"+this.get("centerX")+") translateY(-"+this.get("centerY")+") scale("+this.get("scale")+")"),e.css("-webkit-transform","translateX(-"+this.get("centerX")+") translateY(-"+this.get("centerY")+") scale("+this.get("scale")+")"),e.css("-ms-transform","translateX(-"+this.get("centerX")+") translateY(-"+this.get("centerY")+") scale("+this.get("scale")+")")}}),Adventure.Images=Backbone.Collection.extend({model:Adventure.ImageModel}),Adventure.EffectModel=Backbone.Model.extend({defaults:{name:"",keyframes:"",timing:"linear",duration:1,delay:0,loops:0,direction:"normal",fillMode:"none"},idAttribute:"ID",urlRoot:"services/effect.php",initialize:function(){this.handleBlankName(),this.on("sync",this.handleBlankName)},handleBlankName:function(){this.get("name")||this.set("name","(New effect #"+this.id+")")},validate:function(){var e=validate(this.form,[{name:"name",required:!0,type:"string",maxLength:50},{name:"keyframes",required:!0,type:"string",maxLength:1e3},{name:"timing",required:!0,type:"string",maxLength:40},{name:"duration",required:!0,type:"decimal",maxLength:10},{name:"delay",required:!0,type:"tinyint"},{name:"loops",required:!0,type:"tinyint"},{name:"direction",required:!0,type:"string",maxLength:20},{name:"fillMode",required:!0,type:"string",maxLength:20}]);return e.error?(Adventure.handleInvalidInput(e),e):void 0},applyEffect:function(e){var t="effect-"+this.id+" "+this.get("timing")+" "+this.get("duration")+"s "+this.get("delay")+"s "+("0"==this.get("loops")?"infinite":this.get("loops"))+" "+this.get("direction")+" "+this.get("fillMode");e.css("animation","none"),e.css("-webkit-animation","none"),setTimeout(function(){e.css("animation",t),e.css("-webkit-animation",t)},20)}}),Adventure.Effects=Backbone.Collection.extend({model:Adventure.EffectModel,assembleKeyframes:function(){var e='<style type="text/css">\n',t="";for(var i in this.models)t=Adventure.addCSSSupport(this.models[i].get("keyframes")),e+="@keyframes effect-"+this.models[i].id+"{\n"+t+"\n}\n ",e+="@-webkit-keyframes effect-"+this.models[i].id+"{\n"+t+"\n}\n";return e+="</style>"}}),Adventure.EventModel=Backbone.Model.extend({defaults:{name:"(New Event)",eventTypeID:1,flagID:0,value:null,textBefore:"",textAfter:"",pageID:0,conditionID:1,counterValue:null,counterUpperValue:null,conditionFlagID:0,conditionPageID:0,conditionOtherFlagID:0},idAttribute:"ID",initialize:function(){this.updateName(),this.on("sync",this.updateName)},updateName:function(){var e=0==this.get("flagID")?"(Undefined)":Adventure.activeAdventure.get("flags").get(this.get("flagID")).get("name"),t=0==this.get("pageID")?"(Undefined)":Adventure.activeAdventure.get("pages").get(this.get("pageID")).get("name"),i="(New Event)";switch(int(this.get("eventTypeID"))){case 1:i="Display Text: ",this.get("textBefore")&&this.get("textAfter")?i+='"'+this.get("textBefore").substring(0,15)+(this.get("textBefore").length>15?"...":"")+'" / "'+this.get("textAfter").substring(0,15)+(this.get("textAfter").length>15?"...":"")+'"':this.get("textBefore")?i+='"'+this.get("textBefore").substring(0,15)+(this.get("textBefore").length>15?"...":"")+'"':this.get("textAfter")?i+='"'+this.get("textAfter").substring(0,15)+(this.get("textAfter").length>15?"...":"")+'"':i="(Undefined Event)";break;case 2:i="Set Flag: "+e;break;case 3:i="Remove Flag: "+e;break;case 4:i="Set "+e+" to "+this.get("value");break;case 5:i="Increase "+e+" by "+this.get("value");break;case 6:i="Jump to Page: "+t;break;case 7:i="Store Current Page";break;case 8:i="Jump to Stored Page";break;case 9:i="Stop Executing Events"}if(int(this.get("conditionID"))>1){e=0==this.get("conditionFlagID")?"(Undefined)":Adventure.activeAdventure.get("flags").get(this.get("conditionFlagID")).get("name");var n=int(this.get("conditionOtherFlagID"))?Adventure.activeAdventure.get("flags").get(this.get("conditionOtherFlagID")).get("name"):"";switch(i+=" if ",int(this.get("conditionID"))){case 2:i+=e+" Active";break;case 3:i+=e+" Inactive";break;case 4:i+=e+" = "+(n?n:this.get("counterValue"));break;case 5:i+=e+" != "+(n?n:this.get("counterValue"));break;case 6:i+=e+" < "+(n?n:this.get("counterValue"));break;case 7:i+=e+" <= "+(n?n:this.get("counterValue"));break;case 8:i+=e+" > "+(n?n:this.get("counterValue"));break;case 9:i+=e+" >= "+(n?n:this.get("counterValue"));break;case 10:i+=e+" between "+this.get("counterValue")+" and "+this.get("counterUpperValue");break;case 11:i+=e+" not between "+this.get("counterValue")+" and "+this.get("counterUpperValue");break;case 12:i+="Random number between "+this.get("counterValue")+" and "+this.get("counterUpperValue");break;case 13:i+="Page = "+Adventure.activeAdventure.get("pages").get(this.get("conditionPageID")).get("name");break;case 14:i+="Page != "+Adventure.activeAdventure.get("pages").get(this.get("conditionPageID")).get("name")}}this.set("name",i)},urlRoot:"services/event.php",validate:function(){var e=int(Adventure.eventTypes.get(this.form.find("[name='eventTypeID']").val()).get("involvesFlag")),t=int(Adventure.eventTypes.get(this.form.find("[name='eventTypeID']").val()).get("involvesValue")),i=int(Adventure.eventTypes.get(this.form.find("[name='eventTypeID']").val()).get("involvesPage")),n=int(this.form.find("[name='conditionID']").val())>1&&int(this.form.find("[name='conditionID']").val())<11,a=int(Adventure.conditions.get(this.form.find("[name='conditionID']").val()).get("involvesCounter")),s=int(Adventure.conditions.get(this.form.find("[name='conditionID']").val()).get("involvesRange")),r=int(Adventure.conditions.get(this.form.find("[name='conditionID']").val()).get("involvesPage")),o=validate(this.form,[{name:"eventTypeID",required:!0,type:"tinyint"},{name:"flagID",required:e,type:"uint"},{name:"value",required:t,type:"int"},{name:"textBefore",required:!1,type:"string",maxLength:200},{name:"textAfter",required:!1,type:"string",maxLength:200},{name:"pageID",required:i,type:"uint"},{name:"conditionID",required:!0,type:"tinyint"},{name:"conditionFlagID",required:n,type:"uint"},{name:"counterValue",required:a,type:"int"},{name:"counterUpperValue",required:s,type:"int"},{name:"conditionPageID",required:r,type:"uint"},{name:"conditionOtherFlagID",required:a&&!s,type:"uint"}]);return o.error?(Adventure.handleInvalidInput(o),o):void 0}}),Adventure.Events=Backbone.Collection.extend({model:Adventure.EventModel}),Adventure.SceneEventModel=Backbone.Model.extend({defaults:{name:"",eventID:0,priority:0},idAttribute:"ID",initialize:function(){this.on("sync",this.updateName)},updateName:function(){int(this.get("eventID"))>0?this.set("name",this.get("priority")+": "+Adventure.activeAdventure.get("events").get(this.get("eventID")).get("name")):this.set("name","(Undefined event)")},urlRoot:"services/sceneEvent.php",validate:function(){var e=validate(this.form,[{name:"eventID",required:!0,type:"uint"},{name:"priority",required:!0,type:"tinyint"}]);return e.error?(Adventure.handleInvalidInput(e),e):void 0}}),Adventure.SceneEvents=Backbone.Collection.extend({model:Adventure.SceneEventModel,comparator:function(e){return int(e.get("priority"))}}),Adventure.PageEventModel=Backbone.Model.extend({defaults:{name:"",eventID:0,priority:0},idAttribute:"ID",initialize:function(){this.on("sync",this.updateName)},updateName:function(){int(this.get("eventID"))>0?this.set("name",this.get("priority")+": "+Adventure.activeAdventure.get("events").get(this.get("eventID")).get("name")):this.set("name","(Undefined event)")},urlRoot:"services/pageEvent.php",validate:function(){var e=validate(this.form,[{name:"eventID",required:!0,type:"uint"},{name:"priority",required:!0,type:"tinyint"}]);return e.error?(Adventure.handleInvalidInput(e),e):void 0}}),Adventure.PageEvents=Backbone.Collection.extend({model:Adventure.PageEventModel,comparator:function(e){return int(e.get("priority"))}}),Adventure.ActionEventModel=Backbone.Model.extend({defaults:{name:"",eventID:0,priority:0},idAttribute:"ID",initialize:function(){this.on("sync",this.updateName)},updateName:function(){int(this.get("eventID"))>0?this.set("name",this.get("priority")+": "+Adventure.activeAdventure.get("events").get(this.get("eventID")).get("name")):this.set("name","(Undefined event)")},urlRoot:"services/actionEvent.php",validate:function(){var e=validate(this.form,[{name:"eventID",required:!0,type:"uint"},{name:"priority",required:!0,type:"tinyint"}]);return e.error?(Adventure.handleInvalidInput(e),e):void 0}}),Adventure.ActionEvents=Backbone.Collection.extend({model:Adventure.ActionEventModel,comparator:function(e){return int(e.get("priority"))}}),Adventure.PageTypeModel=Backbone.Model.extend({defaults:{name:"",style:""},idAttribute:"ID"}),Adventure.PageTypes=Backbone.Collection.extend({model:Adventure.PageTypeModel}),Adventure.TransitionModel=Backbone.Model.extend({defaults:{name:""},idAttribute:"ID"}),Adventure.Transitions=Backbone.Collection.extend({model:Adventure.TransitionModel}),Adventure.ConditionModel=Backbone.Model.extend({defaults:{name:"",involvesFlag:0,involvesCounter:0,involvesRange:0,involvesPage:0},idAttribute:"ID",evaluateCondition:function(e,t,i,n,a,s,r){switch(t=int(t),i=int(i),n=n||0,a=int(a)||0,s=int(s)||0,int(this.id)){case 2:return 1==e;case 3:return 0==e;case 4:return e==(void 0!==r&&null!==r?r:t);case 5:return e!=(void 0!==r&&null!==r?r:t);case 6:return(void 0!==r&&null!==r?r:t)>e;case 7:return(void 0!==r&&null!==r?r:t)>=e;case 8:return e>(void 0!==r&&null!==r?r:t);case 9:return e>=(void 0!==r&&null!==r?r:t);case 10:return e>=t&&i>=e;case 11:return!(e>=t&&i>=e);case 12:return n>=t&&i>=n;case 13:return s==a;case 14:return s!=a;default:return!0}}}),Adventure.Conditions=Backbone.Collection.extend({model:Adventure.ConditionModel}),Adventure.EventTypeModel=Backbone.Model.extend({defaults:{name:"",involvesFlag:0,involvesValue:0,involvesPage:0},idAttribute:"ID"}),Adventure.EventTypes=Backbone.Collection.extend({model:Adventure.EventTypeModel}),Adventure.ActionTypeModel=Backbone.Model.extend({defaults:{name:"",requiresText:0},idAttribute:"ID"}),Adventure.ActionTypes=Backbone.Collection.extend({model:Adventure.ActionTypeModel}),Adventure.initStatic=function(e){$.ajax({type:"POST",url:Adventure.assetPath+"services/static.php",success:function(t){Adventure.pageTypes=new Adventure.PageTypes(t.pageTypes),Adventure.transitions=new Adventure.Transitions(t.transitions),Adventure.conditions=new Adventure.Conditions(t.conditions),Adventure.eventTypes=new Adventure.EventTypes(t.eventTypes),Adventure.actionTypes=new Adventure.ActionTypes(t.actionTypes),e()},dataType:"json"}).fail(function(){alert("An error occurred while retrieving static data.")})},Adventure.Viewer=Marionette.LayoutView.extend({el:"#adventure",template:"Viewer",currentPageType:"normal",startingPage:0,transitionData:{},side:"A",otherSide:"B",blankHeight:0,regions:{imageA:".image-container.page-A",imageB:".image-container.page-B",pageA:".page-body.page-A",pageB:".page-body.page-B",inventory:".inventory-container",actionsA:".actions.page-A",actionsB:".actions.page-B"},ui:{closeBox:".adventure-background .close-box",overlay:".overlay",closeYes:".close-dialog .option-yes",closeNo:".close-dialog .option-no"},initialize:function(){var e=this;Adventure.initStatic(function(){e.setup()})},setup:function(){this.model=new Adventure.AdventureViewingModel({hashKey:this.$el.attr("data-adventure")}),this.variables={flags:[]},this.inventorySet=new Adventure.Flags,this.listenTo(this.model,"sync",function(){this.resetVariables(),this.resetTransitionData(),this.$el.prepend(this.model.get("effects").assembleKeyframes()),this.transitionData.nextPageID=this.variables.startingPage,this.loadPage(),this.resetTransitionData(),this.$el.find(".image-manager .page-"+this.otherSide).hide(),this.$el.find(".action-manager .page-"+this.otherSide).hide(),this.$el.find(".page-manager").height(this.$el.find(".page-manager .page-"+this.side).innerHeight()),this.$el.find(".action-manager").height(this.$el.find(".action-manager .page-"+this.side).outerHeight(!0)),this.trimActions(),this.resizeBox()});var e=this;$(window).on("resize",function(){e.resizeBox()}),this.render()},onRender:function(){this.showChildView("inventory",new Adventure.Inventory({collection:this.inventorySet})),this.$el.find(".adventure-background-transition").hide(),this.$el.find(".adventure-box").css("top",$(window).scrollTop()+48+"px"),this.resizeBox()},events:{"click @ui.closeBox":function(){this.$el.find(".close-dialog").show()},"dblclick @ui.overlay":function(){this.$el.find(".close-dialog").show()},"click @ui.closeYes":function(){this.$el.find(".close-dialog").hide(),this.$el.find(".adventure-container").addClass("closing"),_.delay(function(e){e.destroy()},1e3,this)},"click @ui.closeNo":function(){this.$el.find(".close-dialog").hide()}},resetVariables:function(){var e=this;this.variables.startingPage=this.model.get("pages").models[0].id,this.variables.currentPage=0,this.variables.checkpointPage=0,this.variables.storedPage=0,this.model.get("flags").each(function(t){e.variables.flags[int(t.id)]=int(t.get("isCounter"))?int(t.get("counterDefault"))||0:0,int(t.get("isItem"))&&e.inventorySet.add(t)}),this.savedVariables=JSON.parse(JSON.stringify(this.variables))},resetTransitionData:function(){this.transitionData.transitioning=!1,this.transitionData.nextPageID=0,this.transitionData.nextPageClass="normal",this.transitionData.effectID=0,this.transitionData.transitionID=1,this.transitionData.beforePageText="",this.transitionData.afterPageText="",this.transitionData.randomRoll=0},beginTransition:function(){if(this.resizeBox(),this.transitionData.effectID>0){var e=this.model.get("effects").get(this.transitionData.effectID);e?(e.applyEffect(this.$el.find(".image-manager .page-"+this.side+" img")),_.delay(function(e){e.$el.find(".image-manager .page-"+e.side+" img").css("animation","initial"),e.handleTransition()},e.get("duration")*e.get("loops")*1e3,this)):this.handleTransition()}else this.handleTransition()},handleTransition:function(){var e=this;switch(this.transitionData.transitioning=!0,this.otherSide=this.side,this.side="A"==this.side?"B":"A",0==this.transitionData.nextPageID&&(this.transitionData.nextPageID=this.variables.currentPage),this.loadPage(),this.backgroundTransition(this.transitionData.nextPageClass),int(this.transitionData.transitionID)){case 1:this.$el.find(".image-manager .page-"+this.otherSide).css("z-index",1),this.$el.find(".image-manager .page-"+this.side).css("z-index",2).fadeIn(1e3,function(){e.$el.find(".image-manager .page-"+e.otherSide).hide()});break;case 2:this.$el.find(".image-manager .page-"+this.side).show(),this.$el.find(".image-manager .page-"+this.otherSide).hide();break;case 3:this.$el.find(".image-manager .blank").addClass("black").fadeIn(500,function(){e.$el.find(".image-manager .page-"+e.side).show(),e.$el.find(".image-manager .page-"+e.otherSide).hide(),e.$el.find(".image-manager .blank").fadeOut(500,function(){$(this).removeClass("black")})});break;case 4:this.$el.find(".image-manager .blank").addClass("white").fadeIn(500,function(){e.$el.find(".image-manager .page-"+e.side).show(),e.$el.find(".image-manager .page-"+e.otherSide).hide(),e.$el.find(".image-manager .blank").fadeOut(500,function(){$(this).removeClass("white")})});break;case 5:this.$el.find(".image-manager .page-"+this.side).show(),this.$el.find(".image-manager .page-"+this.side+" div").css("left","-100%").animate({left:"0%"},1e3),this.$el.find(".image-manager .page-"+this.otherSide+" div").animate({left:"100%"},1e3,function(){$(this).css("left","0%"),e.$el.find(".image-manager .page-"+e.otherSide).hide()});break;case 6:this.$el.find(".image-manager .page-"+this.side).show(),this.$el.find(".image-manager .page-"+this.side+" div").css("left","100%").animate({left:"0%"},1e3),this.$el.find(".image-manager .page-"+this.otherSide+" div").animate({left:"-100%"},1e3,function(){$(this).css("left","0%"),e.$el.find(".image-manager .page-"+e.otherSide).hide()});break;case 7:this.$el.find(".image-manager .page-"+this.side).show(),this.$el.find(".image-manager .page-"+this.side+" div").css("top","-100%").animate({top:"0%"},1e3),this.$el.find(".image-manager .page-"+this.otherSide+" div").animate({top:"100%"},1e3,function(){$(this).css("top","0%"),e.$el.find(".image-manager .page-"+e.otherSide).hide()});break;case 8:this.$el.find(".image-manager .page-"+this.side).show(),this.$el.find(".image-manager .page-"+this.side+" div").css("top","100%").animate({top:"0%"},1e3),this.$el.find(".image-manager .page-"+this.otherSide+" div").animate({top:"-100%"},1e3,function(){$(this).css("top","0%"),e.$el.find(".image-manager .page-"+e.otherSide).hide()})}this.$el.find(".page-manager .page-"+this.side).css("top","100%").css("bottom",""),this.$el.find(".page-manager").animate({height:this.$el.find(".page-manager .page-"+this.side).innerHeight()+"px"},1e3),this.$el.find(".page-manager .page-"+this.side).animate({top:"0%"},1e3),this.$el.find(".page-manager .page-"+this.otherSide).css("top","").animate({bottom:"100%"},1e3),this.$el.find(".action-manager .page-"+this.side).show().css("left","100%").fadeOut(750,function(){e.$el.find(".action-manager .page-"+e.side).css("left","0%").fadeIn(250)}),_.delay(function(e){e.trimActions()},751,this),this.$el.find(".action-manager .page-"+this.otherSide).fadeOut(250),this.$el.find(".action-manager").animate({height:this.$el.find(".action-manager .page-"+this.side).outerHeight(!0)+"px"},1e3,function(){e.resetTransitionData(),e.$el.find(".adventure-manager").removeClass("transitioning")});var t=this.blankHeight+this.$el.find(".image-manager .page-"+this.side).innerHeight()+this.$el.find(".page-manager .page-"+this.side).innerHeight()+this.$el.find(".action-manager .page-"+this.side).outerHeight(!0)+this.$el.find(".inventory-container").outerHeight(!0);t%16>0&&(t+=16-t%16),this.$el.find(".adventure-box").animate({height:t+"px"}),this.$el.find(".adventure-manager").addClass("transitioning").animate({height:t-16+"px"})},loadPage:function(){return this.variables.currentPage=this.transitionData.nextPageID,pageModel=this.model.get("pages").get(this.transitionData.nextPageID),sceneModel=this.model.get("scenes").get(pageModel.get("sceneID")),sceneModel&&(pageModel.get("actions").add(sceneModel.get("actions").toJSON()),sceneModel.get("sceneEvents").each(function(e){pageModel.get("pageEvents").add({ID:"s_"+e.id,priority:e.get("priority"),eventID:e.get("eventID")})})),this.handleEvents(pageModel.get("pageEvents")),this.transitionData.nextPageID!=this.variables.currentPage?(this.loadPage(),!1):(this.transitionData.nextPageClass=Adventure.pageTypes.get(pageModel.get("pageTypeID")).get("style"),"checkpoint"==this.transitionData.nextPageClass&&(this.variables.checkpointPage=this.transitionData.nextPageID,this.savedVariables=JSON.parse(JSON.stringify(this.variables)),this.transitionData.beforePageText=Adventure.Templates.Checkpoint+this.transitionData.beforePageText),("death"==this.transitionData.nextPageClass||"badEnding"==this.transitionData.nextPageClass||"goodEnding"==this.transitionData.nextPageClass)&&("goodEnding"!=this.transitionData.nextPageClass&&pageModel.get("actions").add({ID:"checkpoint",text:"Return to Checkpoint"}),pageModel.get("actions").add({ID:"restart",text:"Restart"})),this.showChildView("image"+this.side,new Adventure.ViewerImage({model:this.model.get("images").get(pageModel.get("imageID")),effect:this.model.get("effects").get(pageModel.get("effectID"))})),this.showChildView("page"+this.side,new Adventure.ViewerPage({model:pageModel,beforeText:this.transitionData.beforePageText,afterText:this.transitionData.afterPageText})),void this.showChildView("actions"+this.side,new Adventure.ViewerActionList({collection:pageModel.get("actions")})))},backgroundTransition:function(e){if(this.currentPageType!=e){var t=this;
this.$el.find(".adventure-background-transition").addClass(e),this.$el.find(".adventure-background-transition").fadeIn(1e3,function(){t.$el.find(".adventure-background").removeClass(t.currentPageType),t.$el.find(".adventure-background").addClass(e),t.$el.find(".adventure-background-transition").removeClass(e),t.$el.find(".adventure-background-transition").hide(),t.currentPageType=e})}},performAction:function(e){this.transitionData.transitioning||(this.transitionData.randomRoll=Math.floor(101*Math.random()),e.get("actionEvents").length&&this.handleEvents(e.get("actionEvents")),int(e.get("nextPageID"))>0&&!this.transitionData.nextPageID&&(this.transitionData.nextPageID=e.get("nextPageID")),int(e.get("effectID"))>0&&(this.transitionData.effectID=e.get("effectID")),int(e.get("transitionID"))>0&&(this.transitionData.transitionID=e.get("transitionID")),this.beginTransition())},restart:function(){this.resetVariables(),this.transitionData.nextPageID=this.variables.startingPage,this.transitionData.transitionID=3,this.transitionData.randomRoll=Math.floor(101*Math.random()),this.beginTransition()},returnToCheckpoint:function(){this.variables=JSON.parse(JSON.stringify(this.savedVariables)),this.transitionData.nextPageID=this.variables.checkpointPage,this.transitionData.transitionID=3,this.transitionData.randomRoll=Math.floor(101*Math.random()),this.beginTransition()},handleEvents:function(e){var t=this;e.every(function(e){var i=t.model.get("events").get(e.get("eventID"));if(Adventure.conditions.get(i.get("conditionID")).evaluateCondition(t.variables.flags[int(i.get("conditionFlagID"))]||0,i.get("counterValue"),i.get("counterUpperValue"),t.transitionData.randomRoll,t.variables.currentPage,i.get("conditionPageID"),t.variables.flags[int(i.get("conditionOtherFlagID"))])){switch(""!=i.get("textBefore")&&(t.transitionData.beforePageText+=i.get("textBefore")+"<br><br>"),""!=i.get("textAfter")&&(t.transitionData.afterPageText+="<br><br>"+i.get("textAfter")),int(i.get("eventTypeID"))){case 2:t.variables.flags[int(i.get("flagID"))]=1;break;case 3:t.variables.flags[int(i.get("flagID"))]=0;break;case 4:t.variables.flags[int(i.get("flagID"))]=int(i.get("value"));break;case 5:t.variables.flags[int(i.get("flagID"))]+=int(i.get("value"));break;case 6:return t.transitionData.nextPageID=i.get("pageID"),!1;case 7:t.variables.storedPage=t.variables.currentPage;break;case 8:t.transitionData.nextPageID||(t.transitionData.nextPageID=t.variables.storedPage);break;case 9:return!1}if(int(i.get("flagID"))&&int(t.model.get("flags").get(i.get("flagID")).get("isCounter"))){var n=null!=t.model.get("flags").get(i.get("flagID")).get("counterMinimum")?int(t.model.get("flags").get(i.get("flagID")).get("counterMinimum")):null,a=null!=t.model.get("flags").get(i.get("flagID")).get("counterMaximum")?int(t.model.get("flags").get(i.get("flagID")).get("counterMaximum")):null;if(int(t.model.get("flags").get(i.get("flagID")).get("counterWraps"))&&null!=n&&null!=a){for(;t.variables.flags[int(i.get("flagID"))]<n;)t.variables.flags[int(i.get("flagID"))]+=a-n+1;for(;t.variables.flags[int(i.get("flagID"))]>a;)t.variables.flags[int(i.get("flagID"))]-=a-n+1}else null!=n&&t.variables.flags[int(i.get("flagID"))]<n?t.variables.flags[int(i.get("flagID"))]=n:null!=a&&t.variables.flags[int(i.get("flagID"))]>a&&(t.variables.flags[int(i.get("flagID"))]=a)}}return!0}),this.inventorySet.trigger("change")},trimActions:function(){this.$el.find(".action-manager .page-"+this.side+" .selection > div").each(function(){$(this).css("width","100%"),$(this).css("width",Math.min($(this).find("p").outerWidth()+26,$(this).outerWidth())+"px")})},resizeBox:function(){var e=Math.min($(".adventure-container").width(),640);$(".adventure-box").width(Math.max(e-e%16,160)),this.$el.find(".page-manager").height(this.$el.find(".page-manager .page-"+this.side).innerHeight()),this.$el.find(".action-manager").height(this.$el.find(".action-manager .page-"+this.side).outerHeight(!0));var t=$(".adventure-content").innerHeight();t%16>0&&$(".adventure-box").height(t+16-t%16),this.blankHeight=this.$el.find(".adventure-box").height()-this.$el.find(".image-manager .page-"+this.side).innerHeight()-this.$el.find(".page-manager .page-"+this.side).innerHeight()-this.$el.find(".action-manager .page-"+this.side).outerHeight(!0)-this.$el.find(".inventory-container").outerHeight(!0),this.trimActions()},onDestroy:function(){$(window).off("resize load",this.resizeBox)}}),Adventure.ViewerImage=Marionette.ItemView.extend({template:"ViewerImage",onRender:function(){this.$el.find("img").attr("src",Adventure.assetPath+"uploads/"+this.model.get("URL")),this.$el.find("img").css("transform","translateX(-"+this.model.get("centerX")+") translateY(-"+this.model.get("centerY")+") scale("+this.model.get("scale")+")"),this.$el.find("img").css("-webkit-transform","translateX(-"+this.model.get("centerX")+") translateY(-"+this.model.get("centerY")+") scale("+this.model.get("scale")+")"),this.$el.find("img").css("-ms-transform","translateX(-"+this.model.get("centerX")+") translateY(-"+this.model.get("centerY")+") scale("+this.model.get("scale")+")"),this.getOption("effect")&&this.getOption("effect").applyEffect(this.$el.find("img"))}}),Adventure.ViewerPage=Marionette.ItemView.extend({template:"ViewerPage",initialize:function(e){this.model.set("combinedText",e.beforeText+this.model.get("filteredText")+e.afterText)}}),Adventure.ViewerActionButton=Marionette.ItemView.extend({template:"ViewerActionButton",className:"selection",events:{click:function(e){switch(e.preventDefault(),this.model.id){case"restart":Adventure.viewer.restart();break;case"checkpoint":Adventure.viewer.returnToCheckpoint();break;default:Adventure.viewer.performAction(this.model)}return!1}},modelEvents:{change:"render"}}),Adventure.ViewerActionList=Marionette.CollectionView.extend({className:"selection-list",childView:Adventure.ViewerActionButton,viewComparator:function(e){return int(e.get("priority"))},filter:function(e){var t=e.get("actionFlagRequirements"),i=!0;return"checkpoint"==e.id&&0==Adventure.viewer.variables.checkpointPage&&(i=!1),t&&t.every(function(e){return Adventure.conditions.get(e.get("conditionID")).evaluateCondition(Adventure.viewer.variables.flags[int(e.get("flagID"))]||0,e.get("counterValue"),e.get("counterUpperValue"),Adventure.viewer.transitionData.randomRoll,Adventure.viewer.variables.currentPage,e.get("pageID"),Adventure.viewer.variables.flags[int(e.get("otherFlagID"))])?void 0:(i=!1,!1)}),i}}),Adventure.InventoryItem=Marionette.ItemView.extend({template:"InventoryItem",className:"item",ui:{description:".description"},onRender:function(){this.renderImage(),int(this.model.get("isCounter"))&&this.$el.find(".quantity").html(Adventure.viewer.variables.flags[this.model.id])},events:{click:function(e){return e.preventDefault(),this.$el.find(".description").toggleClass("clicked"),!1},"click @ui.description":function(e){return e.preventDefault(),this.$el.find(".description").removeClass("clicked"),!1}},modelEvents:{change:"render"},renderImage:function(){var e=Adventure.activeAdventure.get("images").get(this.model.get("imageID"));e?(this.$el.find("img").show().removeAttr("style").attr("src",Adventure.assetPath+"uploads/"+e.get("URL")),this.$el.find("img").css("transform","translateX(-"+e.get("centerX")+") translateY(-"+e.get("centerY")+") scale("+e.get("scale")+")"),this.$el.find("img").css("-webkit-transform","translateX(-"+e.get("centerX")+") translateY(-"+e.get("centerY")+") scale("+e.get("scale")+")"),this.$el.find("img").css("-ms-transform","translateX(-"+e.get("centerX")+") translateY(-"+e.get("centerY")+") scale("+e.get("scale")+")")):this.$el.find("img").hide()}}),Adventure.Inventory=Marionette.CollectionView.extend({className:"inventory",childView:Adventure.InventoryItem,filter:function(e){return Adventure.viewer.variables.flags[e.id]>0},onRender:function(){0==this.$el.find(".item").length?this.$el.hide():0==this.$el.find(":visible").length&&this.$el.fadeIn()},collectionEvents:{change:"render"}}),Adventure.Templates||(Adventure.Templates={}),Adventure.Templates.Viewer='<div class="adventure-container"><div class="overlay"></div><div class="adventure-box"><div class="adventure-manager"><div class="adventure-content"><div class="image-manager"><div class="image-container page-A"></div><div class="image-container page-B"></div><div class="image-container blank"></div></div><div class="page-manager"><div class="page-body page-A"></div><div class="page-body page-B"></div></div><div class="inventory-container"></div><div class="action-manager"><div class="actions page-A"></div><div class="actions page-B"></div></div></div></div><div class="adventure-background-transition"><div class="close-box"></div></div><div class="adventure-background normal"><div class="close-box"></div></div></div><div class="close-dialog">Are you sure you want to end your adventure? Your adventuring progress will be lost.<div class="dialog-button option-yes">Yes, I tire of adventuring.</div><div class="dialog-button option-no">No, I want to continue my adventure.</div></div></div>',Adventure.Templates.ViewerImage="<img />",Adventure.Templates.ViewerPage="<%= combinedText %>",Adventure.Templates.ViewerActionButton='<div class="<%= (actionTypeID == 2) ? "speech-bubble" : "action-box" %>"><% if (actionTypeID == 3 || actionTypeID == 4){ %><img src="<%= Adventure.assetPath + "img/viewer/" + (actionTypeID == 3 ? "forward" : "back") %>-arrow.gif" /><% }else{ %><p><%= text %></p><% } %></div>',Adventure.Templates.InventoryItem='<div class="item-image-container"><img /></div><div class="quantity"></div><div class="description"><div class="description-image-container"><div><img /></div></div><h3><%= name %></h3><p><%= description %></p></div>',Adventure.Templates.Checkpoint='<div class="checkpoint"><span>Checkpoint</span></div>';